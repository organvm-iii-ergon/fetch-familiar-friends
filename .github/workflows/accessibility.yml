name: Accessibility Checks

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  axe-core:
    name: Axe Accessibility Testing
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Serve build
        run: |
          npx serve -s dist -l 3000 &
          sleep 5

      - name: Run axe-core tests
        run: |
          npx @axe-core/cli http://localhost:3000 --verbose --save axe-results.json
        continue-on-error: true

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: axe-results
          path: axe-results.json

  wcag-validation:
    name: WCAG Compliance Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for accessibility attributes
        run: |
          echo "Checking for ARIA labels and alt text..."

          # Check for images without alt text
          if grep -r '<img' src/ | grep -v 'alt=' ; then
            echo "⚠️  Warning: Found images without alt text"
          else
            echo "✅ All images have alt text"
          fi

          # Check for buttons without aria-label
          if grep -r '<button' src/ | grep -v 'aria-label' | grep -v '>.*<' ; then
            echo "⚠️  Warning: Found buttons that may need aria-label"
          else
            echo "✅ Buttons properly labeled"
          fi

      - name: Check color contrast
        uses: actions/github-script@v7
        with:
          script: |
            console.log('Color contrast should be checked manually or with browser tools');
            console.log('Minimum contrast ratios:');
            console.log('- Normal text: 4.5:1');
            console.log('- Large text: 3:1');
            console.log('- UI components: 3:1');

  keyboard-navigation:
    name: Keyboard Navigation Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for keyboard handlers
        run: |
          echo "Checking keyboard navigation support..."

          # Check for onClick without onKeyPress on non-button elements
          if grep -r 'onClick=' src/ | grep -v '<button' | grep -v '<a' | grep -v 'onKeyPress' ; then
            echo "⚠️  Warning: Found onClick handlers that may need keyboard support"
          else
            echo "✅ Interactive elements have keyboard support"
          fi

          # Check for tabIndex usage
          if grep -r 'tabIndex=' src/ ; then
            echo "ℹ️  Note: Custom tabIndex found - verify it's used correctly"
          fi

  a11y-report:
    name: Generate Accessibility Report
    runs-on: ubuntu-latest
    needs: [axe-core, wcag-validation, keyboard-navigation]
    if: github.event_name == 'pull_request'
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## ♿ Accessibility Check Results

            Automated accessibility checks have been completed.

            ### Tests Run:
            - ✅ Axe-core accessibility testing
            - ✅ WCAG compliance validation
            - ✅ Keyboard navigation check

            ### Manual Testing Checklist:
            - [ ] Screen reader compatibility (NVDA/JAWS/VoiceOver)
            - [ ] Keyboard-only navigation
            - [ ] Color contrast ratios (WCAG AA minimum)
            - [ ] Focus indicators visible
            - [ ] Semantic HTML usage
            - [ ] Form labels and error messages
            - [ ] Skip navigation links
            - [ ] Responsive text sizing

            ### Resources:
            - [WCAG 2.1 Guidelines](https://www.w3.org/WAI/WCAG21/quickref/)
            - [axe DevTools](https://www.deque.com/axe/devtools/)
            - [WebAIM Contrast Checker](https://webaim.org/resources/contrastchecker/)

            Please review the artifacts for detailed results.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
