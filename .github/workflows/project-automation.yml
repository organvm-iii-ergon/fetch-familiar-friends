name: Project Board Automation

on:
  issues:
    types: [opened, closed, assigned, unassigned, labeled]
  pull_request:
    types: [opened, closed, ready_for_review, converted_to_draft]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  issues: write
  pull-requests: write
  repository-projects: write

jobs:
  auto-assign-project:
    name: Auto-assign to Project
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - name: Add issue to project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/orgs/ivi374forivi/projects/1
          github-token: ${{ secrets.GITHUB_TOKEN }}

  move-to-in-progress:
    name: Move to In Progress
    runs-on: ubuntu-latest
    if: github.event.action == 'assigned' && github.event.issue
    steps:
      - name: Move assigned issue
        uses: actions/github-script@v7
        with:
          script: |
            // This would move the issue to "In Progress" column
            // Requires GitHub Projects GraphQL API
            console.log('Issue assigned:', context.payload.issue.number);

  move-to-review:
    name: Move to Review
    runs-on: ubuntu-latest
    if: github.event.pull_request && github.event.action == 'ready_for_review'
    steps:
      - name: Move PR to review
        uses: actions/github-script@v7
        with:
          script: |
            console.log('PR ready for review:', context.payload.pull_request.number);

  move-to-done:
    name: Move to Done
    runs-on: ubuntu-latest
    if: (github.event.issue && github.event.action == 'closed') || (github.event.pull_request && github.event.pull_request.merged)
    steps:
      - name: Move to done
        uses: actions/github-script@v7
        with:
          script: |
            const itemType = context.payload.issue ? 'Issue' : 'PR';
            const itemNumber = context.payload.issue?.number || context.payload.pull_request?.number;
            console.log(`${itemType} completed:`, itemNumber);

  label-size:
    name: Label Issue Size
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' && github.event.issue
    steps:
      - name: Estimate issue size
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.issue.body || '';
            const bodyLength = body.length;

            let sizeLabel = 'size/s';
            if (bodyLength > 1000) sizeLabel = 'size/l';
            else if (bodyLength > 500) sizeLabel = 'size/m';

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: [sizeLabel]
            });

  priority-notification:
    name: Notify on High Priority
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'priority: critical') || contains(github.event.issue.labels.*.name, 'priority: high')
    steps:
      - name: Send notification
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: '⚠️ This issue has been marked as high priority and will be reviewed soon.'
            });
